<?php
/**
 * @file
 * Code for CIS LMS-less to place branding on page and create experience.
 */

/**
 * Implements hook_permission().
 */
function cis_lmsless_permission() {
  return array(
    'view lmsless bar' =>  array(
      'title' => t('View LMSless bar'),
      'description' => t('Provides context as to what system you are in and quick links.'),
    ),
    'view lmsless cis link' =>  array(
      'title' => t('View link to CIS space'),
      'description' => t('This shows the shortcut to the marketing space in CIS.'),
    ),
  );
}

/**
 * Implements hook_page_alter().
 */
function cis_lmsless_page_alter(&$page) {
  if (user_access('view lmsless bar') && !path_is_admin(current_path())) {
    // append output to page via normal page rendering
    $page['page_bottom']['lmsless'] = array(
      '#type' => 'markup',
      '#markup' => _cis_lmsless_assemble(),
      '#weight' => 1000,
    );
  }
}

/**
 * Callback to assemble the bar
 */
function _cis_lmsless_assemble() {
  // assemble variables for theming
  $vars = array(
    'front_page' => variable_get('site_frontpage','node'),
    'site_name' => variable_get('site_name', t('Service')),
  );
  // build in section context if we have one we can pull
  if ($section = _cis_connector_section_context()) {
    $vars['section'] = $section;
  }
  // request a list of all other services that this section uses
  if (!$services = _cis_connector_transaction('other_services')) {
    $services = $list = array();
    $distro = variable_get('install_profile', 'standard');
    $reg = _cis_connector_build_registry($distro);
    $list[$distro] = array(
      'title' => $reg['default_title'],
      'url' => '#',
      'machine_name' => $distro,
    );
  }
  else {
    foreach ($services as $service) {
      $list[$service['field_machine_name']] = array(
        'title' => $service['title'],
        'url' => $service['field_location']['url'] . base_path(),
        'machine_name' => $service['field_machine_name'],
      );
    }
  }
  // add in link to the CIS location if permission exists
  // @ignore druplart_conditional_assignment
  if (user_access('view lmsless cis link') && $settings = _cis_connector_build_registry('cis')) {
    // space it out since this is not to be accessed frequently
    $list['_'] = array(
      'title' => t('_________________________'),
      'url' => '#_blank',
      'machine_name' => '_',
    );
    $list['cis'] = array(
      'title' => t('Course information system'),
      'url' => _cis_connector_format_address($settings, base_path(), 'front'),
      'machine_name' => 'cis',
    );
  }
  // bump current link to the first position and drop url so its internal
  foreach ($list as $key => $item) {
    // see if this service matches the current tool
    if ($item['url'] == $GLOBALS['base_url'] . '/') {
      $tmp = $item;
      $tmp['url'] = '#';
      unset($list[$key]);
      array_unshift($list, $tmp);
    }
  }
  $vars['services'] = $list;
  drupal_add_css(drupal_get_path('module', 'cis_lmsless') . '/css/cis_lmsless.css');
  drupal_add_js(drupal_get_path('module', 'cis_lmsless') . '/js/cis_lmsless.js');
  return theme('cis_lmsless_bar', $vars);
}

/**
 * Implements hook_theme().
 */
function cis_lmsless_theme() {
  return array(
    'cis_lmsless_bar' => array(
      'variables' => array(
        'front_page' => 'node',
        'site_name' => t('Service'),
        'section' => t('Master Section'),
        'services' => array(),
      ),
      'render element' => 'element',
      'template' => 'templates/cis-lmsless-bar',
    ),
  );
}
