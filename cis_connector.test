<?php

/**
 * @file
 * Test suite for CIS Connector module.
 */

/**
 * Base class with some helper methods.
 */
class CISConnectorTestCase extends DrupalWebTestCase {

  /**
   * {@inheritdoc}
   */
  function setUp() {
    parent::setUp(func_get_args());
  }

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return array(
      'name' => 'CIS Connector',
      'description' => 'Tests core CIS Connector capabilities.',
      'group' => 'CIS',
    );
  }

  /**
   * Tests for RestWS meta controllers.
   */
  function testMetaControllers() {
    // Now enable the cis_connector module.
    module_enable(array('cis_connector', 'restws'), TRUE);
    // @todo need to build a fake connection registry for testing call ability
    drupal_flush_all_caches();
    drupal_static_reset();
    // assert meta controllers are working / available
    $controls = restws_meta_controls();
    $this->assertTrue((isset($controls['deep-load-refs']) && isset($controls['xml-out'])), t('CIS Required Metacontrollers active'));
  }

  /**
   * Tests for connection registry given example one.
   */
  function testConnectionRegistry() {
    // Now enable the cis_connector module.
    module_enable(array('simpletest_cis_registry', 'cis_connector'), TRUE);
    drupal_flush_all_caches();
    drupal_static_reset();
    // assert meta controllers are working / available
    $settings = _cis_connector_build_registry();
    $this->assertTrue(isset($settings['cis']), t('CIS Required Metacontrollers active'));
    // @todo test the structure of the data that's supplied
    // @todo build some addresses to ensure that those functions work correctly
  }

  /**
   * Tests against restws w/ deep load
   */
  function testDeepLoadResources() {
    // Now enable the cis_connector module.
    module_enable(array('simpletest_cis_registry', 'restws', 'cis_connector'), TRUE);
    drupal_flush_all_caches();
    drupal_static_reset();
    // assert meta controllers are working / available
    $settings = _cis_connector_build_registry();
    // login so we can start to assert tests against ourself
    $web_user = $this->drupalCreateUser(array('access resource user', 'access resource node'));
    // @todo figure out how to login successfully
    //$this->drupalLogin($web_user);
    // create a new node so we have some data
    $node = $this->drupalCreateNode();
    // @todo figure out how to post to this
    //$this->drupalPost('node.json?deep-load-refs=user', array(), t('Request resources'));
  }
}
